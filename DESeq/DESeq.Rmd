---
title: "DESeq"
author: "Max Alcer"
date: "2024-06-07"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
library(DESeq2)
library(Matrix)
library(tidyverse)
library(BiocParallel)
register(SnowParam(4))
```


```{r}
RNA_expression_matrix <- readRDS("../data/pre_processed/RNA-Seq-filtered.rds")
RNA_expression_matrix <- RNA_expression_matrix + 1
```

```{r}
RNA_annotations <- read_csv("../data/pre_processed/RNA_annotations.csv",show_col_types = FALSE)
```

```{r}
dds <- DESeqDataSetFromMatrix(countData = RNA_expression_matrix,
                              colData = select(RNA_annotations, sample, Sub_trajectory_name),
                              design = ~ Sub_trajectory_name)
```

```{r}
dea <- DESeq(dds, parallel = TRUE)
```

```{r}
results <- results(dea, contrast = c("Sub_trajectory_name", 
                                     "Definitive erythroid trajectory", 
                                     "White blood cell trajectory"))
```

```{r}
plotMA(results)
```
```{r}
Sub_traj <- distinct(RNA_annotations, Sub_trajectory_name)$Sub_trajectory_name
```

```{r}
res_list <- list()
for(i in 1:(length(Sub_traj)-1)){
  for(j in (i+1):length(Sub_traj)){
    temp <- list(results(dea, contrast = c("Sub_trajectory_name",
                                           Sub_traj[i], 
                                           Sub_traj[j])))
    res_list <- append(res_list, temp)
  }
}
```

```{r}
combined_res <- do.call(rbind, lapply(res_list, function(x) {
  tibble(gene = rownames(x), padj = x$padj)
}))

combined_res <- combined_res %>% filter(padj != 0)

combined_res <- combined_res[order(combined_res$padj),]
```

```{r}
write_csv(head(combined_res, 50), "top_50_genes.csv")
```






